#!/usr/bin/env ruby

require 'pathname'
require 'rubygems'
require 'rake'

def find_js_files(path)
  if(path.file?)
    file = path.realpath.to_s
    if(file.end_with?('.js'))
      return [file]
    else
      puts_error "Not a javascript file #{arg}"
      return
    end
  else
    path = path.join('**', '*.js')
    file_list = FileList.new(path)	
  	return file_list.to_a.select { |f| File.file?(f) }
  end
end

def google_compiler(src, target)
  puts_success "Minifying #{src} with Google Closure Compiler..."
  `java -jar /usr/local/google-compiler.jar --js #{src} --summary_detail_level 3 --js_output_file #{target}`
end

def puts_error(text)
  puts "\e[30;41m #{text} \e[0m"
end

def puts_success(text)
  puts "\e[30;42m #{text} \e[0m"
end

def run(elements)
  files = []
  
  elements.each do |arg|
    path = Pathname.new(arg)
    if path.exist?
      files += find_js_files(path)
    else
      puts_error "Uknown file or direcoty #{arg}"
      return
    end
  end
  
  files.each do |src|
    if src.index('.min.').nil?
			target = src.split('.')
			target.pop
			target.push('min')
			target.push('js')
			
			google_compiler(src, target.join('.'))
		end
  end
end

run(ARGV)